<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>BIGã‚«ãƒ¬ãƒ³ãƒ€</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: #000000;
  color: white;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
  width: 100vw;
  height: 100svh;
  height: 100vh;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

/* å®‰å…¨ä½™ç™½ã‚’è€ƒæ…®ã—ãŸã‚³ãƒ³ãƒ†ãƒŠ */
#container {
  text-align: center;
  user-select: none;
  -webkit-user-select: none;
  padding: clamp(8px, 2vmin, 20px);
  max-width: 96vw;
  max-height: 96vh;
  max-height: 96svh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: clamp(8px, 1.5vmin, 16px);
}

/* å¹´ã®è¡¨ç¤º - åŸºæº–ã‚µã‚¤ã‚º */
#year {
  font-size: clamp(16px, 4vmin, 48px);
  color: white;
  line-height: 1.2;
  transition: all 0.2s ease;
}

/* æ—¥ä»˜ã®è¡¨ç¤º - å¹´ã®2å€ */
#date {
  font-size: clamp(32px, 8vmin, 96px);
  font-weight: bold;
  line-height: 1.1;
  display: flex;
  align-items: baseline;
  justify-content: center;
  letter-spacing: -0.02em;
  transition: all 0.2s ease;
}

#date .num {
  line-height: 1;
}

#date .unit {
  font-size: 0.6em;
  line-height: 1;
}

#date .dow {
  line-height: 1;
  margin-left: 0;
}

#date .dow-bracket {
  font-size: 0.6em;
  line-height: 1;
}

/* æ™‚åˆ»ï¼‹éŸ³å£°ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ */
#timeContainer {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0;
  transition: all 0.2s ease;
}

/* ç¸¦å‘ã: æ™‚åˆ»ã®ä¸‹ã«ãƒœã‚¿ãƒ³ */
@media (orientation: portrait) {
  #timeContainer {
    flex-direction: column;
    gap: clamp(8px, 2vmin, 16px);
  }
}

/* æ¨ªå‘ã: æ™‚åˆ»ã®å³ã«ãƒœã‚¿ãƒ³ */
@media (orientation: landscape) {
  #timeContainer {
    flex-direction: row;
    gap: clamp(8px, 2vmin, 20px);
  }
}

/* æ™‚åˆ»ã®è¡¨ç¤º - å¹´ã®2å€ */
#time {
  font-size: clamp(32px, 8vmin, 96px);
  color: #00ff00;
  font-weight: bold;
  line-height: 1.1;
  transition: all 0.2s ease;
}

/* éŸ³å£°ãƒœã‚¿ãƒ³ */
#voiceBtn {
  min-width: 44px;
  min-height: 44px;
  width: clamp(44px, 6vmin, 80px);
  height: clamp(44px, 6vmin, 80px);
  border-radius: 50%;
  background: #ff8c00;
  border: none;
  font-size: clamp(20px, 3vmin, 40px);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.2s;
  flex-shrink: 0;
}

#voiceBtn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* å¼·èª¿è¡¨ç¤º - å‹•çš„ã«å€ç‡ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã€åˆæœŸå€¤ã¯æ§ãˆã‚ */
.highlight {
  font-weight: 900;
  text-shadow: 0 0 20px currentColor;
}

/* è¨ºæ–­ãƒ‘ãƒãƒ« */
#diagnostic {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(50,50,50,0.9);
  color: #ccc;
  padding: 10px;
  border-radius: 8px;
  font-size: clamp(10px, 1.5vmin, 14px);
  max-width: 300px;
  max-height: 400px;
  overflow-y: auto;
  z-index: 1000;
}

#diagnostic.hidden {
  display: none;
}

#diagnostic button {
  margin: 5px 2px;
  padding: 5px 10px;
  font-size: clamp(9px, 1.4vmin, 13px);
  cursor: pointer;
  background: #555;
  color: white;
  border: none;
  border-radius: 4px;
}

#diagnostic button:active {
  background: #777;
}

#diagLog {
  margin-top: 10px;
  font-size: clamp(8px, 1.2vmin, 12px);
  color: #aaa;
  max-height: 200px;
  overflow-y: auto;
  word-break: break-all;
}

#showDiagBtn {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(100,100,100,0.6);
  color: #ddd;
  border: none;
  padding: 8px 12px;
  font-size: clamp(12px, 1.8vmin, 16px);
  border-radius: 4px;
  cursor: pointer;
  z-index: 999;
}

#showDiagBtn.hidden {
  display: none;
}
</style>
</head>
<body>
<div id="container">
  <div id="year"></div>
  <div id="date"></div>
  <div id="timeContainer">
    <div id="time"></div>
    <button id="voiceBtn" onclick="manualSpeak()" ontouchstart="manualSpeak()">ğŸ”Š</button>
  </div>
</div>

<div id="diagnostic">
  <div><strong>è¨ºæ–­ãƒ‘ãƒãƒ«</strong></div>
  <button onclick="testVoice()">éŸ³å£°ãƒ†ã‚¹ãƒˆ</button>
  <button onclick="updateVoiceList()">éŸ³å£°ä¸€è¦§æ›´æ–°</button>
  <button onclick="hideDiag()">éš ã™</button>
  <div id="diagLog"></div>
</div>

<button id="showDiagBtn" class="hidden" onclick="showDiag()">è¨º</button>

<script>
let audioCtx = null;
let userInteracted = false;
let isSpeaking = false;
const fallbackMs = 8000;

// ç¾åœ¨ã®å¼·èª¿è¦ç´ ã‚’è¨˜æ†¶
let currentHighlightedElement = null;
let originalTransform = '';

function log(msg) {
  const logEl = document.getElementById('diagLog');
  const time = new Date().toLocaleTimeString('ja-JP');
  logEl.innerHTML += `[${time}] ${msg}<br>`;
  logEl.scrollTop = logEl.scrollHeight;
}

function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    log('AudioContextåˆæœŸåŒ–');
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
    log('AudioContext resume');
  }
}

function playBeep() {
  initAudio();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value = 800;
  gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.1);
  log('åŠ¹æœéŸ³å†ç”Ÿ');
}

// å®‰å…¨ãªå¼·èª¿è¡¨ç¤ºï¼šã¯ã¿å‡ºã•ãªã„æœ€å¤§å€ç‡ã‚’è¨ˆç®—
function applySafeHighlight(elementId) {
  const element = document.getElementById(elementId);
  if (!element) return;

  // å‰å›ã®å¼·èª¿ã‚’è§£é™¤
  removeSafeHighlight();

  const container = document.getElementById('container');
  const containerRect = container.getBoundingClientRect();
  const elementRect = element.getBoundingClientRect();

  // ç¾åœ¨ã®ã‚µã‚¤ã‚ºã¨ä½™è£•ã‚’è¨ˆç®—
  const availableWidth = containerRect.width * 0.95; // 95%ã¾ã§ä½¿ç”¨å¯
  const availableHeight = containerRect.height * 0.95;

  const widthRatio = availableWidth / elementRect.width;
  const heightRatio = availableHeight / elementRect.height;

  // ã¯ã¿å‡ºã•ãªã„æœ€å¤§å€ç‡ï¼ˆæœ€å¤§1.15å€ã¾ã§ï¼‰
  const maxScale = Math.min(widthRatio, heightRatio, 1.15);
  const safeScale = Math.max(1.0, Math.min(maxScale, 1.15));

  // å…ƒã®transformã‚’ä¿å­˜
  originalTransform = element.style.transform || '';

  // å¼·èª¿ã‚’é©ç”¨
  element.classList.add('highlight');
  element.style.transform = `scale(${safeScale})`;
  currentHighlightedElement = element;

  log(`å¼·èª¿é©ç”¨: ${elementId}, scale=${safeScale.toFixed(2)}`);
}

// å¼·èª¿ã‚’è§£é™¤
function removeSafeHighlight() {
  if (currentHighlightedElement) {
    currentHighlightedElement.classList.remove('highlight');
    currentHighlightedElement.style.transform = originalTransform;
    currentHighlightedElement = null;
  }
}

function speakText(text, elementId, preDelay = 0) {
  return new Promise((resolve) => {
    if (!('speechSynthesis' in window)) {
      log('speechSynthesiséå¯¾å¿œ');
      resolve();
      return;
    }

    // èª­ã¿ä¸Šã’å‰ã®å¾…ã¡æ™‚é–“
    setTimeout(() => {
      speechSynthesis.cancel();
      const ut = new SpeechSynthesisUtterance(text);
      ut.lang = 'ja-JP';
      ut.rate = 0.9;
      ut.pitch = 1.0;
      ut.volume = 1.0;

      const voices = speechSynthesis.getVoices();
      const jaVoice = voices.find(v => v.lang.startsWith('ja'));
      if (jaVoice) ut.voice = jaVoice;

      let ended = false;
      const timer = setTimeout(() => {
        if (!ended) {
          log(`ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ${text}`);
          speechSynthesis.cancel();
          removeSafeHighlight();
          ended = true;
          resolve();
        }
      }, fallbackMs);

      ut.onstart = () => {
        log(`èª­ã¿ä¸Šã’é–‹å§‹: ${text}`);
        if (elementId) applySafeHighlight(elementId);
      };

      ut.onend = () => {
        if (!ended) {
          clearTimeout(timer);
          log(`èª­ã¿ä¸Šã’çµ‚äº†: ${text}`);
          removeSafeHighlight();
          ended = true;
          resolve();
        }
      };

      ut.onerror = (e) => {
        if (!ended) {
          clearTimeout(timer);
          log(`èª­ã¿ä¸Šã’ã‚¨ãƒ©ãƒ¼: ${e.error}`);
          removeSafeHighlight();
          ended = true;
          resolve();
        }
      };

      speechSynthesis.speak(ut);
      if (speechSynthesis.paused) speechSynthesis.resume();
    }, preDelay);
  });
}

async function speakAll() {
  if (isSpeaking) {
    log('èª­ã¿ä¸Šã’ä¸­ã®ãŸã‚ç„¡è¦–');
    return;
  }
  isSpeaking = true;
  document.getElementById('voiceBtn').disabled = true;

  playBeep();

  // èª­ã¿ä¸Šã’é–‹å§‹å‰ã®å¾…ã¡æ™‚é–“ï¼ˆ300msï¼‰
  await new Promise(r => setTimeout(r, 300));

  const now = new Date();
  const year = now.getFullYear();
  const reiwa = year - 2018;
  const month = now.getMonth() + 1;
  const day = now.getDate();
  const dow = now.getDay();
  const dowText = ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'][dow];
  const hour = now.getHours();
  const minute = now.getMinutes();

  // å€‹åˆ¥ã«èª­ã¿ä¸Šã’ï¼šå¹´ â†’ æœˆæ—¥ â†’ æ›œæ—¥ â†’ æ™‚åˆ»
  await speakText(`ä»¤å’Œ${reiwa}å¹´ã€è¥¿æš¦${year}å¹´`, 'year', 0);
  await new Promise(r => setTimeout(r, 300));

  await speakText(`${month}æœˆ${day}æ—¥`, 'date', 0);
  await new Promise(r => setTimeout(r, 300));

  await speakText(dowText, 'date', 0);
  await new Promise(r => setTimeout(r, 300));

  await speakText(`${hour}æ™‚${minute}åˆ†`, 'time', 0);

  isSpeaking = false;
  document.getElementById('voiceBtn').disabled = false;
  log('èª­ã¿ä¸Šã’å®Œäº†');
}

function manualSpeak() {
  if (!userInteracted) {
    userInteracted = true;
    initAudio();
    log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ¤œå‡ºï¼ˆè‡ªå‹•èª­ã¿ä¸Šã’æœ‰åŠ¹åŒ–ï¼‰');
  }
  speakAll();
}

function testVoice() {
  if (!userInteracted) {
    userInteracted = true;
    initAudio();
    log('éŸ³å£°ãƒ†ã‚¹ãƒˆï¼ˆåˆå›æ“ä½œï¼‰');
  }
  speakText('ãƒãƒ­ãƒ¼', null, 0);
}

function updateVoiceList() {
  const voices = speechSynthesis.getVoices();
  log(`éŸ³å£°æ•°: ${voices.length}`);
  voices.forEach((v, i) => {
    log(`${i}: ${v.name} (${v.lang})`);
  });
}

function hideDiag() {
  document.getElementById('diagnostic').classList.add('hidden');
  document.getElementById('showDiagBtn').classList.remove('hidden');
}

function showDiag() {
  document.getElementById('diagnostic').classList.remove('hidden');
  document.getElementById('showDiagBtn').classList.add('hidden');
}

function updateDisplay() {
  const now = new Date();
  const year = now.getFullYear();
  const reiwa = year - 2018;
  const month = now.getMonth() + 1;
  const day = now.getDate();
  const dow = now.getDay();
  const dowStr = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][dow];
  const hour = String(now.getHours()).padStart(2, '0');
  const minute = String(now.getMinutes()).padStart(2, '0');

  document.getElementById('year').textContent = `ä»¤å’Œ${reiwa}å¹´ï¼ˆ${year}å¹´ï¼‰`;

  let dateColor = '#ffff00';
  if (dow === 0) dateColor = '#ff0000';
  if (dow === 6) dateColor = '#00ffff';

  document.getElementById('date').innerHTML = `
    <span class="num" style="color:${dateColor}">${month}</span><span class="unit" style="color:${dateColor}">æœˆ</span>
    <span class="num" style="color:${dateColor}">${day}</span><span class="unit" style="color:${dateColor}">æ—¥</span>
    <span class="dow" style="color:${dateColor}"><span class="dow-bracket">(</span>${dowStr}<span class="dow-bracket">)</span></span>
  `;

  document.getElementById('time').textContent = `${hour}:${minute}`;
}

function checkAutoSpeak() {
  if (!userInteracted) return;
  const now = new Date();
  const h = now.getHours();
  const m = now.getMinutes();
  if (m === 0 && (h === 7 || h === 12 || h === 18)) {
    log(`è‡ªå‹•èª­ã¿ä¸Šã’: ${h}æ™‚`);
    speakAll();
  }
}

function scheduleNextUpdate() {
  const now = new Date();
  const next = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), now.getMinutes() + 1, 0, 0);
  const delay = next - now;
  setTimeout(() => {
    updateDisplay();
    checkAutoSpeak();
    scheduleNextUpdate();
  }, delay);
}

if ('speechSynthesis' in window) {
  speechSynthesis.addEventListener('voiceschanged', () => {
    log('éŸ³å£°ãƒªã‚¹ãƒˆå¤‰æ›´æ¤œå‡º');
  });
}

updateDisplay();
scheduleNextUpdate();
log('BIGã‚«ãƒ¬ãƒ³ãƒ€èµ·å‹•ï¼ˆæ”¹ä¿®ç‰ˆï¼‰');
</script>
</body>
</html>
