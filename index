<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>BIG„Ç´„É¨„É≥„ÉÄ</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  background: #000000;
  color: white;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
  overflow: hidden;
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}
:root {
  --year-size: 8vmin;
  --date-size: 28vmin;
  --time-size: 18vmin;
  --unit: 0.6em;
  --mult: 1;
}
#container {
  text-align: center;
  user-select: none;
  -webkit-user-select: none;
  transform: scale(var(--mult));
}
#year {
  font-size: var(--year-size);
  color: white;
  margin-bottom: 0.5em;
}
#date {
  font-size: var(--date-size);
  font-weight: bold;
  margin-bottom: 0.3em;
  display: flex;
  align-items: baseline;
  justify-content: center;
  letter-spacing: -0.02em;
}
#date .num {
  line-height: 1;
}
#date .unit {
  font-size: var(--unit);
  line-height: 1;
}
#date .dow {
  line-height: 1;
  margin-left: 0;
}
#date .dow-bracket {
  font-size: var(--unit);
  line-height: 1;
}
#time {
  font-size: var(--time-size);
  color: #00ff00;
  font-weight: bold;
  margin-bottom: 1em;
}
#voiceBtn {
  width: 4em;
  height: 4em;
  border-radius: 50%;
  background: #ff8c00;
  border: none;
  font-size: 2em;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.2s;
}
#voiceBtn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.highlight {
  transform: scale(1.3);
  transition: transform 0.2s;
}
#diagnostic {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(50,50,50,0.9);
  color: #ccc;
  padding: 10px;
  border-radius: 8px;
  font-size: 12px;
  max-width: 300px;
  max-height: 400px;
  overflow-y: auto;
  z-index: 1000;
}
#diagnostic.hidden {
  display: none;
}
#diagnostic button {
  margin: 5px 2px;
  padding: 5px 10px;
  font-size: 11px;
  cursor: pointer;
  background: #555;
  color: white;
  border: none;
  border-radius: 4px;
}
#diagnostic button:active {
  background: #777;
}
#diagLog {
  margin-top: 10px;
  font-size: 10px;
  color: #aaa;
  max-height: 200px;
  overflow-y: auto;
  word-break: break-all;
}
#showDiagBtn {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(100,100,100,0.6);
  color: #ddd;
  border: none;
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 4px;
  cursor: pointer;
  z-index: 999;
}
#showDiagBtn.hidden {
  display: none;
}
</style>
</head>
<body>
<div id="container">
  <div id="year"></div>
  <div id="date"></div>
  <div id="time"></div>
  <button id="voiceBtn" onclick="manualSpeak()" ontouchstart="manualSpeak()">üîä</button>
</div>

<div id="diagnostic">
  <div><strong>Ë®∫Êñ≠„Éë„Éç„É´</strong></div>
  <button onclick="testVoice()">Èü≥Â£∞„ÉÜ„Çπ„Éà</button>
  <button onclick="updateVoiceList()">Èü≥Â£∞‰∏ÄË¶ßÊõ¥Êñ∞</button>
  <button onclick="hideDiag()">Èö†„Åô</button>
  <div id="diagLog"></div>
</div>

<button id="showDiagBtn" class="hidden" onclick="showDiag()">Ë®∫</button>

<script>
let audioCtx = null;
let userInteracted = false;
let isSpeaking = false;
const fallbackMs = 8000;

function log(msg) {
  const logEl = document.getElementById('diagLog');
  const time = new Date().toLocaleTimeString('ja-JP');
  logEl.innerHTML += `[${time}] ${msg}<br>`;
  logEl.scrollTop = logEl.scrollHeight;
}

function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    log('AudioContextÂàùÊúüÂåñ');
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
    log('AudioContext resume');
  }
}

function playBeep() {
  initAudio();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value = 800;
  gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.1);
  log('ÂäπÊûúÈü≥ÂÜçÁîü');
}

function speakText(text, elementId) {
  return new Promise((resolve) => {
    if (!('speechSynthesis' in window)) {
      log('speechSynthesisÈùûÂØæÂøú');
      resolve();
      return;
    }
    speechSynthesis.cancel();
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = 'ja-JP';
    ut.rate = 0.9;
    ut.pitch = 1.0;
    ut.volume = 1.0;

    const voices = speechSynthesis.getVoices();
    const jaVoice = voices.find(v => v.lang.startsWith('ja'));
    if (jaVoice) ut.voice = jaVoice;

    let ended = false;
    const timer = setTimeout(() => {
      if (!ended) {
        log(`„Çø„Ç§„É†„Ç¢„Ç¶„Éà: ${text}`);
        speechSynthesis.cancel();
        if (elementId) document.getElementById(elementId).classList.remove('highlight');
        ended = true;
        resolve();
      }
    }, fallbackMs);

    ut.onstart = () => {
      log(`Ë™≠„Åø‰∏ä„ÅíÈñãÂßã: ${text}`);
      if (elementId) document.getElementById(elementId).classList.add('highlight');
    };
    ut.onend = () => {
      if (!ended) {
        clearTimeout(timer);
        log(`Ë™≠„Åø‰∏ä„ÅíÁµÇ‰∫Ü: ${text}`);
        if (elementId) document.getElementById(elementId).classList.remove('highlight');
        ended = true;
        resolve();
      }
    };
    ut.onerror = (e) => {
      if (!ended) {
        clearTimeout(timer);
        log(`Ë™≠„Åø‰∏ä„Åí„Ç®„É©„Éº: ${e.error}`);
        if (elementId) document.getElementById(elementId).classList.remove('highlight');
        ended = true;
        resolve();
      }
    };

    speechSynthesis.speak(ut);
    if (speechSynthesis.paused) speechSynthesis.resume();
  });
}

async function speakAll() {
  if (isSpeaking) {
    log('Ë™≠„Åø‰∏ä„Åí‰∏≠„ÅÆ„Åü„ÇÅÁÑ°Ë¶ñ');
    return;
  }
  isSpeaking = true;
  document.getElementById('voiceBtn').disabled = true;

  playBeep();
  await new Promise(r => setTimeout(r, 200));

  const now = new Date();
  const month = now.getMonth() + 1;
  const day = now.getDate();
  const dowText = ['Êó•ÊõúÊó•', 'ÊúàÊõúÊó•', 'ÁÅ´ÊõúÊó•', 'Ê∞¥ÊõúÊó•', 'Êú®ÊõúÊó•', 'ÈáëÊõúÊó•', 'ÂúüÊõúÊó•'][now.getDay()];
  const hour = now.getHours();
  const minute = now.getMinutes();
  const year = now.getFullYear();
  const reiwa = year - 2018;

  await speakText(`${month}Êúà${day}Êó•`, 'date');
  await new Promise(r => setTimeout(r, 300));
  await speakText(dowText, 'date');
  await new Promise(r => setTimeout(r, 300));
  await speakText(`${hour}ÊôÇ${minute}ÂàÜ`, 'time');
  await new Promise(r => setTimeout(r, 300));
  await speakText(`‰ª§Âíå${reiwa}Âπ¥„ÄÅË•øÊö¶${year}Âπ¥`, 'year');

  isSpeaking = false;
  document.getElementById('voiceBtn').disabled = false;
  log('Ë™≠„Åø‰∏ä„ÅíÂÆå‰∫Ü');
}

function manualSpeak() {
  if (!userInteracted) {
    userInteracted = true;
    initAudio();
    log('„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÊ§úÂá∫ÔºàËá™ÂãïË™≠„Åø‰∏ä„ÅíÊúâÂäπÂåñÔºâ');
  }
  speakAll();
}

function testVoice() {
  if (!userInteracted) {
    userInteracted = true;
    initAudio();
    log('Èü≥Â£∞„ÉÜ„Çπ„ÉàÔºàÂàùÂõûÊìç‰ΩúÔºâ');
  }
  speakText('„Éè„É≠„Éº', null);
}

function updateVoiceList() {
  const voices = speechSynthesis.getVoices();
  log(`Èü≥Â£∞Êï∞: ${voices.length}`);
  voices.forEach((v, i) => {
    log(`${i}: ${v.name} (${v.lang})`);
  });
}

function hideDiag() {
  document.getElementById('diagnostic').classList.add('hidden');
  document.getElementById('showDiagBtn').classList.remove('hidden');
}

function showDiag() {
  document.getElementById('diagnostic').classList.remove('hidden');
  document.getElementById('showDiagBtn').classList.add('hidden');
}

function updateDisplay() {
  const now = new Date();
  const year = now.getFullYear();
  const reiwa = year - 2018;
  const month = now.getMonth() + 1;
  const day = now.getDate();
  const dow = now.getDay();
  const dowStr = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'][dow];
  const hour = String(now.getHours()).padStart(2, '0');
  const minute = String(now.getMinutes()).padStart(2, '0');

  document.getElementById('year').textContent = `‰ª§Âíå${reiwa}Âπ¥Ôºà${year}Âπ¥Ôºâ`;

  let dateColor = '#ffff00';
  if (dow === 0) dateColor = '#ff0000';
  if (dow === 6) dateColor = '#00ffff';

  document.getElementById('date').innerHTML = `
    <span class="num" style="color:${dateColor}">${month}</span><span class="unit" style="color:${dateColor}">Êúà</span>
    <span class="num" style="color:${dateColor}">${day}</span><span class="unit" style="color:${dateColor}">Êó•</span>
    <span class="dow" style="color:${dateColor}"><span class="dow-bracket">(</span>${dowStr}<span class="dow-bracket">)</span></span>
  `;

  document.getElementById('time').textContent = `${hour}:${minute}`;
}

function checkAutoSpeak() {
  if (!userInteracted) return;
  const now = new Date();
  const h = now.getHours();
  const m = now.getMinutes();
  if (m === 0 && (h === 7 || h === 12 || h === 18)) {
    log(`Ëá™ÂãïË™≠„Åø‰∏ä„Åí: ${h}ÊôÇ`);
    speakAll();
  }
}

function scheduleNextUpdate() {
  const now = new Date();
  const next = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), now.getMinutes() + 1, 0, 0);
  const delay = next - now;
  setTimeout(() => {
    updateDisplay();
    checkAutoSpeak();
    scheduleNextUpdate();
  }, delay);
}

function adjustOrientation() {
  const isLandscape = window.innerWidth > window.innerHeight;
  document.documentElement.style.setProperty('--mult', isLandscape ? '1.2' : '1');
}

window.addEventListener('resize', adjustOrientation);
window.addEventListener('orientationchange', adjustOrientation);

if ('speechSynthesis' in window) {
  speechSynthesis.addEventListener('voiceschanged', () => {
    log('Èü≥Â£∞„É™„Çπ„ÉàÂ§âÊõ¥Ê§úÂá∫');
  });
}

updateDisplay();
scheduleNextUpdate();
adjustOrientation();
log('BIG„Ç´„É¨„É≥„ÉÄËµ∑Âãï');
</script>
</body>
</html>
